# Load required libraries
library(readr)
library(stringr)
library(dplyr)
library(writexl)
library(tcltk)
library(purrr)
library(tidyr)

# Function to read file and count word frequencies
count_word_frequencies <- function(file_path) {
  # Read the text file
  text <- read_file(file_path)
  
  # Convert to lowercase and remove punctuation
  text <- tolower(text)
  text <- str_replace_all(text, "[[:punct:]]", "")
  
  # Split into words
  words <- str_split(text, "\\s+")[[1]]
  
  # Count word frequencies
  word_freq <- table(words)
  
  # Calculate total number of words
  total_words <- sum(word_freq)
  
  # Convert to data frame, calculate normalized frequency, and sort
  word_freq_df <- data.frame(
    word = names(word_freq),
    frequency = as.numeric(word_freq),
    normalized_frequency = as.numeric(word_freq) / total_words
  )
  
  return(word_freq_df)
}

# Function to process all files in a folder
process_folder <- function(folder_path) {
  # Get all txt files in the folder
  files <- list.files(folder_path, pattern = "\\.txt$", full.names = TRUE)
  
  # Process each file
  results <- map(files, function(file) {
    freq_df <- count_word_frequencies(file)
    freq_df$file <- basename(file)
    return(freq_df)
  })
  
  # Combine results
  combined_results <- bind_rows(results)
  
  # Calculate overall frequencies
  overall_freq <- combined_results %>%
    group_by(word) %>%
    summarise(
      overall_frequency = sum(frequency),
      overall_normalized_frequency = sum(frequency) / sum(combined_results$frequency)
    )
  
  # Join overall frequencies with individual file frequencies
  final_results <- combined_results %>%
    pivot_wider(
      id_cols = word,
      names_from = file,
      values_from = c(frequency, normalized_frequency),
      values_fill = list(frequency = 0, normalized_frequency = 0)
    ) %>%
    left_join(overall_freq, by = "word") %>%
    arrange(desc(overall_frequency))
  
  return(final_results)
}

# Main program
main <- function() {
  # Open folder selection dialog
  folder_path <- tclvalue(tkchooseDirectory(title = "Select folder containing text files"))
  
  if (nchar(folder_path) == 0) {
    cat("No folder selected. Exiting program.\n")
    return()
  }
  
  # Process all files in the folder
  results <- process_folder(folder_path)
  
  # Open file dialog for saving Excel file
  output_file <- tclvalue(tkgetSaveFile(
    defaultextension = ".xlsx",
    filetypes = "{{Excel Files} {.xlsx}}",
    title = "Save Excel file"
  ))
  
  if (nchar(output_file) == 0) {
    cat("No save location selected. Exiting program.\n")
    return()
  }
  
  # Write to Excel file
  write_xlsx(results, output_file)
  
  cat("Word frequencies have been saved to", output_file, "\n")
}

# Run the main program
main()
