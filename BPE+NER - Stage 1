# ==============================================================================
# ×©×œ×‘ 2: Set Intersection - ×—×™×¤×•×© ×”×ª×××•×ª (×’×¨×¡×” ×™×¦×™×‘×”)
# ==============================================================================

suppressPackageStartupMessages({
  if (!requireNamespace("rstudioapi", quietly=TRUE)) install.packages("rstudioapi")
  if (!requireNamespace("dplyr", quietly=TRUE)) install.packages("dplyr")
  if (!requireNamespace("data.table", quietly=TRUE)) install.packages("data.table") # ×œ×‘×™×¦×•×¢×™× ××”×™×¨×™×
})

library(rstudioapi)
library(dplyr)
library(tools)

cat("=== ×©×œ×‘ 2: ×–×™×”×•×™ ×”×ª×××•×ª (Set Intersection) ===\n\n")

# ===== 1. ×”×’×“×¨×•×ª ×•× ×ª×™×‘×™× =====

# × ×¡×™×•×Ÿ ×—×›× ×œ××ª×¨ ××ª ×ª×™×§×™×™×ª ×”×¤×¨×•×™×§×˜ (×× ×”×¨×¦×ª ××ª ×©×œ×‘ 1 ×”×¨×’×¢)
if (exists("output_dir")) {
  project_dir <- output_dir
} else {
  project_dir <- rstudioapi::selectDirectory(caption = "×‘×—×¨ ××ª ×ª×™×§×™×™×ª ×”×¤×¨×•×™×§×˜ (×”×ª×™×§×™×™×” ×©×‘×” × ×•×¦×¨×• bpe_encoded ×•×›×•')")
}

bpe_dir <- file.path(project_dir, "bpe_encoded")
if (!dir.exists(bpe_dir)) stop("âŒ ×œ× × ××¦××” ×ª×™×§×™×™×ª bpe_encoded! ×•×•×“× ×©×‘×—×¨×ª ××ª ×”×ª×™×§×™×™×” ×”× ×›×•× ×”.")

# ×”×’×“×¨×•×ª ×‘×¨×™×¨×ª ××—×“×œ (××• ×˜×¢×™× ×” ×-config ×× ×§×™×™×)
config_file <- file.path(project_dir, "config_bpe.rds")
if (file.exists(config_file)) {
  config <- readRDS(config_file)
  BPE_SEP <- config$bpe_sep
} else {
  BPE_SEP <- "\u25AA" # ×‘×¨×™×¨×ª ××—×“×œ: ×¨×™×‘×•×¢ ×©×—×•×¨
}

# ×¤×¨××˜×¨×™× ×œ×—×™×¤×•×©
WINDOW_SIZE <- 50L      # ×’×•×“×œ ×”×—×œ×•×Ÿ ×‘×§×•×‘×¥ ×”×™×¢×“
MIN_TOKENS <- 5L        # ××™× ×™××•× ×˜×•×§× ×™× ××©×•×ª×¤×™× ×›×“×™ ×œ×”×—×©×™×‘ ×›×”×ª×××”
MIN_OVERLAP_PCT <- 20L  # ××—×•×– ×—×¤×™×¤×” ××™× ×™××œ×™
BATCH_SIZE <- 200L      # ×’×•×“×œ ××¦×•×•×”

# ===== 2. ×‘×—×™×¨×ª ×§×•×‘×¥ ×”××§×•×¨ =====

cat("\n--- ×‘×—×™×¨×ª ×˜×§×¡×˜ ××§×•×¨ ×œ×”×©×•×•××” ---\n")
cat("×™×™×¤×ª×— ×—×œ×•×Ÿ ×œ×‘×—×™×¨×ª ×§×•×‘×¥ ×”××§×•×¨ (××ª×•×š ×ª×™×§×™×™×ª bpe_encoded)...\n")

source_file <- rstudioapi::selectFile(
  caption = "×‘×—×¨ ××ª ×§×•×‘×¥ ×”××§×•×¨ (×”×˜×§×¡×˜ ×©××ª×” ××—×¤×© ×¦×™×˜×•×˜×™× ×©×œ×•)",
  path = bpe_dir,
  filter = "Text Files (*.txt)",
  existing = TRUE
)

if (is.null(source_file) || is.na(source_file)) stop("×œ× × ×‘×—×¨ ×§×•×‘×¥ ××§×•×¨.")

# ×™×¦×™×¨×ª ×ª×™×§×™×™×ª ×ª×•×¦××•×ª ×™×™×¢×•×“×™×ª ×œ×§×•×‘×¥ ×”×–×”
source_name <- file_path_sans_ext(basename(source_file))
results_dir <- file.path(project_dir, paste0("results_setint_", source_name))
if (!dir.exists(results_dir)) dir.create(results_dir, recursive = TRUE)

cat(sprintf("âœ“ ×”××§×•×¨ × ×‘×—×¨: %s\n", source_name))
cat(sprintf("âœ“ ×”×ª×•×¦××•×ª ×™×™×©××¨×• ×‘: %s\n", basename(results_dir)))

# ===== 3. ×”×›× ×ª × ×ª×•× ×™× =====

# ×¤×•× ×§×¦×™×™×ª ×§×¨×™××” ×•×¤×™×¦×•×œ
read_and_split <- function(path) {
  # ×§×¨×™××” ×‘×™× ××¨×™×ª ××”×™×¨×”
  con <- file(path, open = "rb")
  size <- file.info(path)$size
  if (is.na(size) || size == 0) { close(con); return(character(0)) }
  txt <- rawToChar(readBin(con, "raw", n = size))
  close(con)
  
  # ×¤×™×¦×•×œ ×œ×¤×™ ×”××¤×¨×™×“
  tokens <- unlist(strsplit(txt, BPE_SEP))
  return(tokens[tokens != ""])
}

cat("â€º ×˜×•×¢×Ÿ ××ª ×§×•×‘×¥ ×”××§×•×¨ ×œ×–×™×›×¨×•×Ÿ... ")
source_tokens <- read_and_split(source_file)
source_set <- unique(source_tokens) # Set ×œ×—×™×¤×•×© ××”×™×¨ O(1)
cat(sprintf("âœ“ (%d ×˜×•×§× ×™× ×™×™×—×•×“×™×™×)\n", length(source_set)))

# ×¨×©×™××ª ×§×‘×¦×™ ×™×¢×“ (×›×œ ×”×ª×™×§×™×™×”, ×œ××¢×˜ ×”××§×•×¨ ×¢×¦××•)
target_files <- list.files(bpe_dir, pattern = "\\.txt$", full.names = TRUE, recursive = TRUE)
target_files <- target_files[normalizePath(target_files) != normalizePath(source_file)]

if (length(target_files) == 0) stop("×œ× × ××¦××• ×§×‘×¦×™× ×œ×”×©×•×•××”!")

# ===== 4. ×œ×•×’×™×§×ª RESUME ×•× ×™×”×•×œ ××¦×•×•×ª =====

all_batches <- split(target_files, ceiling(seq_along(target_files) / BATCH_SIZE))
total_batches <- length(all_batches)

# ×‘×“×™×§×” ××” ×›×‘×¨ ×‘×•×¦×¢
done_files <- list.files(results_dir, pattern = "batch_.*_results\\.rds$")
done_ids <- as.integer(gsub("batch_|_results\\.rds", "", done_files))

if (length(done_ids) > 0) {
  start_batch <- max(done_ids) + 1
  cat(sprintf("âœ“ × ××¦××• %d ××¦×•×•×ª ××•×›× ×•×ª. ×××©×™×š ×××¦×•×•×” %d...\n", length(done_ids), start_batch))
} else {
  start_batch <- 1
}

if (start_batch > total_batches) {
  cat("\nğŸ‰ ×›×œ ×”×”×©×•×•××•×ª ×¢×‘×•×¨ ×§×•×‘×¥ ×–×” ×›×‘×¨ ×‘×•×¦×¢×•!\n×¢×‘×•×¨ ×œ×©×œ×‘ 3 (××™×—×•×“ ×ª×•×¦××•×ª).\n")
} else {

  # ===== 5. ×œ×•×œ××ª ×”×¢×™×‘×•×“ (Core Logic) =====
  
  cat("\nğŸš€ ××ª×—×™×œ ×¡×¨×™×§×” ×•×”×©×•×•××”...\n")
  global_start <- Sys.time()
  
  for (b_idx in start_batch:total_batches) {
    batch_files_list <- all_batches[[b_idx]]
    batch_results <- list()
    
    cat(sprintf("[Batch %d/%d | %d ×§×‘×¦×™×] ", b_idx, total_batches, length(batch_files_list)))
    
    # ×¢×™×‘×•×“ ××§×‘×™×œ×™ ×œ× ××¤×©×¨×™ ×‘×§×œ×•×ª ×‘-RStudio ×¨×’×™×œ ×œ×œ× ×—×‘×™×œ×•×ª ××•×¨×›×‘×•×ª, 
    # ××– × ×©×ª××© ×‘×œ×•×œ××” ×¨×’×™×œ×” ××š ×™×¢×™×œ×”.
    
    hits_in_batch <- 0
    
    for (f_path in batch_files_list) {
      t_tokens <- read_and_split(f_path)
      n_tokens <- length(t_tokens)
      
      if (n_tokens < MIN_TOKENS) next
      
      # --- ×œ×•×’×™×§×ª Sliding Window ---
      # ×× ×• ×¢×•×‘×¨×™× ×¢×œ ×§×•×‘×¥ ×”×™×¢×“ ×‘×—×œ×•× ×•×ª
      # ×›×“×™ ×œ×™×™×¢×œ: × ×‘×“×•×§ ×§×•×“× ×× ×™×© ×‘×›×œ×œ ×—×¤×™×¤×” ×’×œ×•×‘×œ×™×ª ××™× ×™××œ×™×ª
      intersect_global <- length(intersect(unique(t_tokens), source_set))
      if (intersect_global < MIN_TOKENS) next 
      
      # ×× ×™×© ×¤×•×˜× ×¦×™××œ, ×¨×¦×™× ×¢× ×—×œ×•×Ÿ
      starts <- seq(1, max(1, n_tokens - WINDOW_SIZE + 1), by = 1)
      
      for (s in starts) {
        e <- min(s + WINDOW_SIZE - 1, n_tokens)
        window <- t_tokens[s:e]
        
        # ×‘×“×™×§×” ××”×™×¨×”
        shared <- window[window %in% source_set]
        cnt <- length(shared)
        
        if (cnt >= MIN_TOKENS) {
          pct <- (cnt / length(window)) * 100
          if (pct >= MIN_OVERLAP_PCT) {
            # × ××¦××” ×”×ª×××”!
            rel_name <- get_safe_relative_path(f_path, bpe_dir) # ×©×™××•×© ×‘××•×ª×” ×œ×•×’×™×§×” ××©×œ×‘ 1 ×× ×”×•×’×“×¨×”, ××• basename
            if(!exists("get_safe_relative_path")) rel_name <- sub(paste0("^", bpe_dir, "/"), "", f_path)

            batch_results[[length(batch_results) + 1]] <- data.frame(
              target_file = rel_name,
              window_start = s,
              window_end = e,
              overlap_count = cnt,
              overlap_pct = round(pct, 1),
              shared_tokens = paste(unique(shared), collapse = " "),
              stringsAsFactors = FALSE
            )
          }
        }
      }
    }
    
    # ×©××™×¨×ª ×ª×•×¦××•×ª ×”××¦×•×•×”
    if (length(batch_results) > 0) {
      final_df <- do.call(rbind, batch_results)
      hits_in_batch <- nrow(final_df)
      saveRDS(final_df, file.path(results_dir, sprintf("batch_%04d_results.rds", b_idx)))
    } else {
      # ×©×•××¨×™× ×§×•×‘×¥ ×¨×™×§ ×›×“×™ ×œ×¡××Ÿ ×©×”××¦×•×•×” ×‘×•×¦×¢×” (×—×©×•×‘ ×œ-Resume!)
      saveRDS(data.frame(), file.path(results_dir, sprintf("batch_%04d_results.rds", b_idx)))
    }
    
    # ×¡×˜×˜×•×¡
    elapsed <- difftime(Sys.time(), global_start, units = "mins")
    pct_done <- round(100 * b_idx / total_batches, 1)
    cat(sprintf("âœ“ × ×©××¨ (%d ×”×ª×××•×ª). %.1f%%\n", hits_in_batch, pct_done))
  }
  
  cat("\nğŸ ×¡×™×™×× ×• ××ª ×©×œ×‘ 2!\n")
  cat(sprintf("×›×œ ×”×ª×•×¦××•×ª ×©××•×¨×•×ª ×‘×ª×™×§×™×™×”: %s\n", basename(results_dir)))
}
